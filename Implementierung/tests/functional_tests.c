#include "../src/combine.h"
#include "../src/convolution.h"
#include "../src/denoise.h"
#include "../src/grayscale.h"
#include <stdio.h>

int check(char* prefix, const uint8_t* expected, const uint8_t* actual, size_t size, int exact)
{
    int fail = 0;
    for (size_t i = 0; i < size; i++) {
        // testing for correctness while allowing for rounding and integer division errors
        if (exact && expected[i] != actual[i]) {
            printf("%s test failed at index %zu: expected %d, actual %d\n", prefix, i, expected[i], actual[i]);
            fail++;
            if (fail > 10)
                return 1;
        } else if (!exact && expected[i] != actual[i] && abs((int)expected[i] - (int)actual[i]) > 2) {
            printf("%s test failed at index %zu: expected %d, actual %d\n", prefix, i, expected[i], actual[i]);
            fail++;
            if (fail > 10)
                return 1;
        }
    }
    if (fail)
        return 1;
    printf("%s Test passed\n", prefix);
    return 0;
}

int test_grayscale()
{
    // using random numbers and a seperate implementation for testing purposes
    const uint8_t rgb_image[] = {
        180, 223, 108, 167, 47, 48, 75, 121, 135, 121, 217, 92, 4, 122, 246, 10, 132, 99, 131, 91, 155, 233, 30, 246, 13, 139, 117, 24, 206, 102, 135, 244, 95, 101, 44, 174, 12, 81, 206, 103, 39, 25, 165, 108, 103, 53, 158, 135, 6, 61, 79, 95, 156, 238, 214, 246, 208, 165, 142, 22,
        176, 232, 89, 6, 90, 197, 227, 126, 74, 251, 176, 42, 31, 70, 251, 247, 215, 211, 192, 8, 111, 87, 219, 50, 125, 96, 105, 236, 32, 237, 179, 128, 50, 145, 154, 248, 190, 238, 140, 12, 88, 166, 27, 30, 165, 155, 191, 216, 57, 211, 206, 100, 3, 164, 141, 111, 192, 104, 100, 115,
        135, 128, 226, 58, 142, 217, 164, 29, 74, 147, 250, 210, 48, 88, 45, 67, 65, 169, 204, 42, 100, 254, 35, 69, 232, 177, 238, 136, 30, 9, 89, 151, 250, 153, 162, 165, 179, 161, 196, 28, 199, 39, 242, 239, 45, 123, 140, 117, 123, 158, 179, 116, 204, 220, 200, 112, 104, 38, 100, 203,
        203, 154, 118, 225, 221, 66, 159, 124, 123, 169, 121, 150, 19, 229, 85, 102, 94, 114, 173, 99, 33, 27, 72, 101, 28, 76, 248, 116, 246, 13, 24, 160, 26, 135, 242, 83, 133, 49, 28, 24, 229, 97, 203, 9, 81, 183, 51, 224, 84, 16, 228, 22, 216, 148, 163, 12, 185, 248, 211, 149,
        37, 5, 198, 35, 209, 47, 146, 14, 57, 235, 5, 253, 236, 165, 107, 156, 21, 76, 9, 137, 190, 1, 59, 224, 40, 245, 234, 142, 157, 49, 174, 216, 184, 123, 111, 134, 106, 173, 79, 118, 228, 252, 101, 76, 1, 104, 2, 86, 124, 204, 56, 188, 231, 227, 45, 139, 155, 117, 9, 79,
        209, 238, 102, 135, 13, 9, 8, 252, 81, 253, 45, 190, 103, 164, 215, 70, 149, 182, 8, 157, 18, 216, 123, 66, 142, 80, 12, 161, 146, 50, 16, 237, 39, 142, 2, 1, 239, 235, 242, 245, 143, 153, 63, 9, 244, 202, 156, 232, 56, 225, 167, 168, 213, 142, 183, 222, 105, 78, 65, 160,
        223, 142, 198, 212, 86, 193, 41, 28, 35, 90, 211, 111, 82, 44, 18, 9, 234, 210, 86, 191, 215, 204, 39, 42, 87, 132, 83, 47, 203, 243, 108, 253, 219, 190, 73, 78, 64, 77, 61, 110, 197, 247, 54, 75, 9, 156, 170, 14, 150, 160, 183, 233, 218, 146, 119, 240, 108, 225, 204, 168,
        78, 31, 170, 80, 229, 145, 2, 178, 68, 214, 76, 55, 138, 73, 15, 255, 22, 214, 119, 17, 226, 218, 123, 54, 255, 18, 45, 153, 196, 189, 107, 132, 231, 50, 212, 205, 138, 75, 5, 30, 0, 158, 83, 72, 123, 54, 168, 128, 2, 210, 21, 87, 209, 151, 129, 60, 117, 56, 200, 186,
        68, 27, 92, 86, 17, 219, 239, 91, 162, 196, 60, 198, 148, 11, 242, 159, 68, 182, 13, 135, 42, 237, 81, 133, 239, 206, 207, 70, 95, 129, 231, 180, 231, 223, 130, 32, 100, 23, 113, 74, 165, 99, 181, 5, 84, 27, 204, 243, 122, 162, 245, 50, 109, 38, 193, 45, 98, 154, 188, 37,
        108, 113, 204, 228, 122, 194, 196, 31, 227, 201, 31, 167, 205, 1, 49, 230, 65, 149, 89, 66, 195, 209, 198, 247, 215, 186, 42, 70, 41, 183, 111, 124, 168, 232, 59, 61, 126, 209, 47, 180, 147, 137, 232, 30, 60, 0, 143, 139, 70, 173, 127, 31, 36, 204, 90, 178, 48, 184, 129, 229
    };

    uint8_t expected_result[] = {
        176, 83, 111, 151, 124, 86, 122, 156, 95, 120, 167, 100, 98, 54, 124, 120, 50, 162, 225, 113,
        172, 97, 141, 158, 113, 223, 94, 129, 107, 155, 120, 180, 194, 89, 70, 188, 163, 80, 144, 106,
        160, 139, 83, 207, 63, 97, 108, 111, 212, 56, 162, 160, 177, 100, 182, 128, 154, 182, 136, 112,
        158, 176, 134, 144, 123, 102, 101, 67, 113, 137, 79, 162, 68, 128, 89, 143, 100, 137, 109, 204,
        73, 108, 67, 148, 169, 78, 115, 91, 180, 120, 194, 122, 125, 202, 61, 58, 136, 217, 116, 62,
        189, 48, 128, 151, 161, 135, 71, 134, 78, 122, 111, 44, 238, 177, 96, 193, 157, 178, 175, 97,
        183, 156, 34, 145, 48, 159, 167, 89, 104, 168, 199, 110, 68, 186, 49, 119, 164, 201, 164, 200,
        87, 159, 92, 111, 75, 150, 110, 131, 97, 181, 154, 161, 73, 56, 91, 122, 91, 155, 98, 153,
        59, 98, 157, 142, 121, 130, 71, 143, 216, 98, 211, 129, 73, 118, 82, 163, 175, 70, 105, 133,
        139, 175, 139, 123, 77, 140, 112, 216, 152, 92, 133, 112, 136, 154, 100, 99, 128, 85, 113, 176
    };
    uint8_t expected_result_coeffs_not_1[] = {
        182, 57, 122, 169, 153, 112, 115, 117, 122, 158, 187, 91, 117, 39, 111, 142, 63, 178, 231, 104,
        181, 119, 117, 138, 126, 216, 56, 153, 101, 115, 106, 184, 202, 108, 74, 196, 197, 63, 140, 105,
        161, 160, 54, 229, 71, 99, 74, 63, 201, 31, 179, 162, 174, 133, 176, 131, 162, 202, 116, 129,
        146, 171, 126, 134, 165, 101, 83, 78, 129, 160, 106, 182, 49, 170, 48, 118, 91, 179, 80, 194,
        71, 142, 38, 104, 152, 50, 144, 109, 225, 120, 202, 119, 137, 227, 53, 37, 149, 226, 137, 40,
        191, 21, 177, 109, 176, 154, 100, 112, 63, 116, 155, 13, 238, 154, 90, 184, 193, 186, 181, 97,
        167, 131, 31, 169, 38, 209, 191, 53, 112, 204, 231, 84, 71, 207, 52, 118, 167, 196, 187, 194,
        80, 190, 128, 80, 59, 103, 93, 108, 45, 190, 162, 197, 57, 54, 90, 146, 132, 181, 84, 184,
        51, 89, 126, 116, 97, 112, 95, 110, 209, 104, 201, 105, 58, 136, 45, 203, 186, 81, 74, 136,
        142, 154, 108, 89, 33, 105, 110, 215, 141, 90, 137, 73, 149, 146, 56, 131, 150, 91, 129, 166
    };

    uint8_t result[200];
    uint8_t result_simd[200];
    uint8_t result_int[200];
    uint8_t result_coeffs_not_1[200];
    uint8_t result_int_coeffs_not_1[200];
    uint8_t result_simd_coeffs_not_1[200];

    grayscale(rgb_image, 20, 10, 0.3, 0.4, 0.3, result);
    grayscale_integer(rgb_image, 20, 10, 0.3, 0.4, 0.3, result_int);
    grayscale_simd(rgb_image, 20, 10, 0.3, 0.4, 0.3, result_simd);
    grayscale(rgb_image, 20, 10, 0.91, 6.95, 3.83, result_coeffs_not_1);
    grayscale_integer(rgb_image, 20, 10, 0.91, 6.95, 3.83, result_int_coeffs_not_1);
    grayscale_simd(rgb_image, 20, 10, 0.91, 6.95, 3.83, result_simd_coeffs_not_1);

    return check("Grayscale Accurate", expected_result, result, 200, 1)
        + check("Grayscale Integer", expected_result, result_int, 200, 0)
        + check("Grayscale SIMD", expected_result, result_simd, 200, 0)
        + check("Grayscale Accurate (coefficients don't sum to 1)", expected_result_coeffs_not_1, result_coeffs_not_1, 200, 1)
        + check("Grayscale Integer (coefficients don't sum to 1)", expected_result_coeffs_not_1, result_int_coeffs_not_1, 200, 0)
        + check("Grayscale SIMD (coefficients don't sum to 1)", expected_result_coeffs_not_1, result_simd_coeffs_not_1, 200, 0);
}

int test_pad_image()
{
    // 3x17
    uint8_t image[] = {
        24, 206, 102, 135, 244, 95, 101, 44, 174, 12, 81, 206, 13, 14, 15, 16, 17,
        103, 39, 25, 165, 108, 103, 53, 158, 135, 6, 61, 79, 95, 18, 19, 20, 21,
        156, 238, 214, 246, 208, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33
    };
    uint16_t expected_result[] = {
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 24, 206, 102, 135, 244, 95, 101, 44, 174, 12, 81, 206, 13, 14, 15, 16, 17, 0,
        0, 103, 39, 25, 165, 108, 103, 53, 158, 135, 6, 61, 79, 95, 18, 19, 20, 21, 0,
        0, 156, 238, 214, 246, 208, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
    };
    uint16_t result[95] = { 0 };
    pad_image_simd(image, 17, 3, 19, result);
    // If expected result and the actual result are equal, converting the uint16_t array to uint8_t array should result in the same array
    return check("Pad image", (uint8_t*)expected_result, (uint8_t*)result, 95 * 2, 1); // * 2 = * sizeof(uint16_t) / sizeof(uint8_t)
}

int test_convolution()
{
    uint8_t image[] = {
        88, 175, 126, 153, 180, 138, 113, 158, 170, 135, 146, 111, 103, 255,
        101, 66, 117, 125, 70, 153, 70, 116, 97, 152, 109, 128, 120, 202,
        80, 97, 72, 164, 169, 84, 112, 94, 173, 116, 191, 122, 119, 199,
        59, 64, 128, 215, 113, 68, 183, 52, 113, 162, 160, 133, 61, 135,
        78, 119, 97, 48, 238, 180, 105, 196, 149, 174, 170, 101, 187, 163,
        34, 137, 48, 151, 164, 95, 100, 164, 193, 113, 67, 184, 46, 113,
        164, 199, 155, 199, 93, 151, 82, 115, 75, 163, 120, 131, 106, 179
    };
    // expected results generated using matrix convolution in matlab
    uint8_t expected_result_blur[] = {
        61, 92, 99, 104, 108, 99, 91, 100, 108, 105, 98, 89, 107, 109,
        72, 101, 115, 128, 130, 119, 109, 117, 132, 138, 135, 125, 142, 136,
        60, 85, 111, 140, 131, 111, 106, 109, 126, 144, 147, 130, 130, 118,
        56, 87, 115, 146, 144, 126, 123, 120, 132, 154, 154, 130, 124, 106,
        59, 94, 103, 128, 156, 143, 132, 145, 152, 151, 142, 130, 128, 102,
        76, 115, 115, 132, 149, 131, 121, 142, 151, 135, 126, 126, 121, 95,
        79, 112, 113, 113, 103, 88, 82, 87, 95, 96, 94, 91, 90, 75
    };

    uint8_t expected_result_laplace[] = {
        19, 105, 15, 45, 90, 27, 22, 58, 73, 18, 57, 17, 19, 179,
        43, 57, 20, 1, 87, 63, 54, 11, 56, 38, 45, 13, 18, 59,
        16, 27, 55, 19, 61, 42, 4, 19, 68, 54, 64, 21, 7, 85,
        4, 37, 16, 102, 60, 72, 99, 95, 21, 21, 4, 22, 83, 29,
        25, 25, 11, 127, 112, 54, 60, 79, 20, 26, 45, 68, 94, 54,
        61, 37, 87, 36, 20, 54, 12, 13, 68, 36, 80, 98, 102, 16,
        106, 85, 44, 99, 36, 84, 10, 35, 43, 86, 30, 29, 17, 124
    };
    uint8_t result_blur_2_1d[98];
    uint16_t blur_tmp[98];
    uint8_t result_laplace[98];
    uint8_t result_blur[98];
    uint8_t result_laplace_integer[98];
    uint8_t result_blur_integer[98];
    uint16_t padded_image[144] = { 0 };
    uint16_t padded_laplace[144];
    uint16_t padded_blur[144];
    uint8_t result_blur_simd[98];
    uint8_t result_laplace_simd[98];

    blur_2_1d(image, 14, 7, blur_tmp, result_blur_2_1d);
    convolution(image, 14, 7, result_laplace, laplace_kernel, 1);
    convolution(image, 14, 7, result_blur, blur_kernel, 0);
    convolution_1pass(image, 14, 7, result_laplace_integer, result_blur_integer);
    pad_image_simd(image, 14, 7, 16, padded_image);
    convolution_simd(padded_image, 16, 9, padded_laplace, padded_blur);
    // unpad
    for (size_t y = 0; y < 7; y++) {
        for (size_t x = 0; x < 14; x++) {
            result_laplace_simd[y * 14 + x] = (uint8_t)padded_laplace[(y + 1) * 16 + x + 1];
            result_blur_simd[y * 14 + x] = (uint8_t)padded_blur[(y + 1) * 16 + x + 1];
        }
    }
    return check("Convolution Accurate: blur", expected_result_blur, result_blur, 98, 1)
        + check("Convolution Accurate: laplace", expected_result_laplace, result_laplace, 98, 1)
        + check("Convulution Integer: blur 2 1d", expected_result_blur, result_blur_2_1d, 98, 0)
        + check("Convolution Integer: blur", expected_result_blur, result_blur_integer, 98, 0)
        + check("Convolution Integer: laplace", expected_result_laplace, result_laplace_integer, 98, 0)
        + check("Convolution SIMD: blur", expected_result_blur, result_blur_simd, 98, 0)
        + check("Convolution SIMD: laplace", expected_result_laplace, result_laplace_simd, 98, 0);
}

int test_combine()
{
    uint8_t grayscale[] = {
        102, 94, 114, 173, 99, 33, 27,
        246, 13, 24, 160, 26, 135, 242,
        97, 203, 9, 81, 183, 51, 224,
        163, 12, 185, 248, 211, 149, 37,
        14, 57, 235, 5, 253, 236, 165
    };

    uint8_t laplace[] = {
        17, 36, 41, 79, 41, 32, 41,
        193, 128, 50, 84, 118, 47, 145,
        56, 170, 114, 69, 90, 121, 141,
        132, 140, 59, 127, 2, 15, 97,
        41, 8, 173, 179, 140, 94, 96
    };

    uint8_t blur[] = {
        68, 69, 75, 93, 72, 57, 49,
        106, 94, 77, 103, 99, 111, 114,
        102, 105, 90, 123, 135, 131, 115,
        72, 101, 130, 164, 180, 155, 94,
        31, 68, 105, 118, 144, 145, 84
    };

    uint8_t expected_result[] = {
        70, 73, 81, 118, 76, 54, 45,
        212, 53, 67, 122, 65, 115, 187,
        101, 170, 54, 112, 152, 93, 175,
        119, 52, 143, 206, 180, 155, 72,
        28, 68, 193, 39, 204, 179, 114
    };

    uint8_t result[35];
    uint8_t result_int[35];
    combine(grayscale, laplace, blur, 7, 5, result, 1);
    combine(grayscale, laplace, blur, 7, 5, result_int, 0);
    return check("Combine Accurate", expected_result, result, 35, 1)
        + check("Combine Integer", expected_result, result_int, 35, 0);
}

int test_combine_simd()
{
    uint8_t image[] = {
        24, 206, 102, 135, 244, 95, 101, 44, 174, 12, 81, 206, 13, 14, 15, 16, 17,
        103, 39, 25, 165, 108, 103, 53, 158, 135, 6, 61, 79, 95, 18, 19, 20, 21,
        156, 238, 214, 246, 208, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33
    };
    // The 65535 values should not effect the result
    uint16_t blur[] = {
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 47, 80, 84, 106, 120, 90, 66, 77, 78, 48, 60, 83, 49, 16, 12, 13, 10, 65535,
        65535, 81, 112, 123, 154, 148, 97, 73, 92, 86, 50, 56, 78, 59, 30, 21, 22, 17, 65535,
        65535, 84, 119, 130, 143, 116, 57, 34, 44, 40, 26, 26, 34, 32, 24, 20, 21, 16, 65535,
        65535, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
    };
    uint16_t laplace[] = {
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 53, 165, 11, 7, 160, 17, 53, 64, 126, 53, 11, 163, 66, 3, 3, 3, 8, 65535,
        65535, 48, 104, 105, 37, 72, 34, 43, 94, 44, 53, 13, 19, 60, 22, 2, 2, 4, 65535,
        65535, 71, 136, 87, 99, 114, 62, 2, 28, 21, 12, 2, 6, 9, 11, 11, 11, 20, 65535,
        65535, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
    };
    uint8_t expected_result[] = {
        42, 162, 85, 107, 198, 90, 73, 69, 125, 41, 61, 162, 40, 16, 12, 13, 10,
        85, 82, 83, 156, 137, 98, 70, 116, 94, 41, 56, 78, 67, 29, 21, 22, 17,
        104, 182, 159, 183, 157, 48, 34, 42, 39, 26, 26, 34, 32, 24, 20, 21, 17
    };
    uint8_t result[51];
    combine_simd(image, laplace, blur, 17, 3, 19, result);
    return check("Combine SIMD", expected_result, result, 51, 0);
}

int run_all_func_tests()
{
    printf("\nTesting correctness of functions...\n\n");
    return (test_grayscale() + test_pad_image() + test_convolution() + test_combine() + test_combine_simd());
}